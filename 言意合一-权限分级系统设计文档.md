# 言意合一 - 权限分级系统设计文档

## 1. 需求概述

### 1.1 业务需求
实现基于用户身份的三级权限体系:
- **游客模式**: 仅使用本地基础功能,不涉及任何服务端交互
- **免费用户**: 登录后可使用部分在线功能,但无法使用云端存储和同步
- **付费会员**: 解锁完整功能,包括数据同步、云端存储、AI 助手等

### 1.2 核心原则
1. **默认本地优先**: 游客和免费用户默认使用本地存储
2. **渐进式体验**: 用户可随时升级会员,无需重新登录
3. **数据隔离**: 不同权限级别的数据物理隔离
4. **无缝迁移**: 游客升级后可将本地数据迁移到云端

---

## 2. 权限分级方案

### 2.1 权限等级定义

| 权限等级 | 认证状态 | 存储方式 | 数据同步 | 核心限制 |
|---------|---------|---------|---------|---------|
| **游客 (Guest)** | 未登录 | 纯本地存储 | ❌ 不支持 | 无云端功能,无数据同步 |
| **免费用户 (Free)** | 已登录 | 本地存储为主 | ❌ 不支持 | 可使用基础在线功能,但无云端存储 |
| **付费会员 (Member)** | 已登录 | 云端存储为主 | ✅ 支持 | 完整功能,无限制 |

### 2.2 功能权限矩阵

| 功能模块 | 游客 | 免费用户 | 付费会员 | 说明 |
|---------|-----|---------|---------|------|
| **本地文章管理** | ✅ | ✅ | ✅ | 创建、编辑、删除本地文章 |
| **富文本编辑** | ✅ | ✅ | ✅ | 完整的 Quill 编辑功能 |
| **本地搜索** | ✅ | ✅ | ✅ | 搜索本地文章 |
| **用户登录** | ✅ | ✅ | ✅ | 微信/抖音登录 |
| **查看会员页** | ✅ | ✅ | ✅ | 查看会员权益和价格 |
| **数据统计** | ✅ 本地统计 | ✅ 本地统计 | ✅ 云端统计 | 免费/游客仅本地,会员云端 |
| **AI 助手** | ❌ | ❌ (仅本地 Demo) | ✅ | 会员可使用真实 AI API |
| **云端存储** | ❌ | ❌ | ✅ | 云端保存文章,多设备同步 |
| **数据同步** | ❌ | ❌ | ✅ | 自动同步到云端 |
| **数据导出** | ❌ | ❌ | ✅ | 导出 PDF/Markdown |
| **无限文章** | ❌ 限制 50 篇 | ❌ 限制 100 篇 | ✅ 无限制 | 游客/免费用户有数量限制 |
| **自定义主题** | ❌ | ❌ | ✅ | 自定义字体、颜色 |
| **优先客服** | ❌ | ❌ | ✅ | 专属客服通道 |

---

## 3. 服务端设计

### 3.1 认证中间件设计

#### 3.1.1 认证守卫 (Auth Guard)
```typescript
// src/common/guards/auth.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { UserType } from '../decorators/user-type.decorator';

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // 获取装饰器标记的权限要求
    const requiredAuth = this.reflector.get<UserType>(
      'userType',
      context.getHandler(),
    );

    // 如果没有标记,默认为游客可访问
    if (!requiredAuth) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    // 游客路由
    if (requiredAuth === UserType.GUEST) {
      return true;
    }

    // 需要登录的路由
    if (requiredAuth === UserType.AUTHENTICATED) {
      return user && user.isAuthenticated;
    }

    // 需要会员的路由
    if (requiredAuth === UserType.MEMBER) {
      return user && user.isAuthenticated && user.isPaidMember;
    }

    return false;
  }
}
```

#### 3.1.2 用户类型装饰器
```typescript
// src/common/decorators/user-type.decorator.ts
export enum UserType {
  GUEST = 'guest',              // 游客
  AUTHENTICATED = 'authenticated',  // 已登录
  MEMBER = 'member',            // 付费会员
}

export const UserType = (type: UserType) =>
  SetMetadata('userType', type);
```

### 3.2 Controller 权限控制示例

```typescript
// src/modules/articles/articles.controller.ts
import { Controller, Get, Post, UseGuards } from '@nestjs/common';
import { AuthGuard } from '../../common/guards/auth.guard';
import { UserType } from '../../common/decorators/user-type.decorator';

@Controller('articles')
@UseGuards(AuthGuard)  // 全局应用认证守卫
export class ArticlesController {

  // 游客可访问 - 仅用于本地操作的 API
  @Get('local')
  @UserType(UserType.GUEST)
  async getLocalArticles() {
    // 返回本地存储的文章列表 (实际可能是空的,因为游客数据完全在本地)
    return { message: '请使用本地存储' };
  }

  // 需要登录 - 获取云端文章列表
  @Get()
  @UserType(UserType.AUTHENTICATED)
  async getCloudArticles(@Request() req) {
    // 仅返回当前用户的文章
    return this.articlesService.findByUserId(req.user.userId);
  }

  // 需要会员 - 同步数据到云端
  @Post('sync')
  @UserType(UserType.MEMBER)
  async syncToCloud(@Request() req, @Body() syncDto: SyncDto) {
    // 检查会员状态
    if (!req.user.isPaidMember) {
      throw new ForbiddenException('此功能需要会员权限');
    }

    return this.articlesService.syncToCloud(req.user.userId, syncDto);
  }

  // 需要会员 - AI 建议
  @Post('ai/suggest')
  @UserType(UserType.MEMBER)
  async generateSuggestion(@Request() req, @Body() dto: AIDto) {
    // 检查会员状态和配额
    const membership = await this.membershipService.findByUserId(req.user.userId);

    if (!membership || !membership.isValid) {
      throw new ForbiddenException('AI 助手需要有效会员');
    }

    // 检查 AI 配额
    if (membership.remainingAIQuota <= 0) {
      throw new ForbiddenException('AI 配额已用完,请升级会员');
    }

    // 生成建议并扣减配额
    const suggestion = await this.aiService.generate(dto);
    await this.membershipService.decrementAIQuota(membership.userId);

    return suggestion;
  }
}
```

### 3.3 用户数据模型扩展

```typescript
// src/modules/users/entities/user.entity.ts
import { Entity, Column, PrimaryGeneratedColumn, OneToOne } from 'typeorm';
import { Membership } from './membership.entity';

@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  wechatOpenid: string;

  @Column({ default: 'User' })
  nickname: string;

  @Column({ default: 'https://cdn.example.com/default-avatar.png' })
  avatarUrl: string;

  @Column({ default: 'free' })
  membershipLevel: string;  // 'free' | 'monthly' | 'yearly' | 'lifetime'

  @Column({ type: 'boolean', default: false })
  isPaidMember: boolean;

  @Column({ type: 'int', default: 0 })
  articleCount: number;  // 文章数量 (免费用户限制)

  @Column({ type: 'int', default: 100 })
  remainingAIQuota: number;  // AI 配额

  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  lastLoginAt: Date;

  // 关联会员信息
  @OneToOne(() => Membership, (membership) => membership.user)
  membership: Membership;
}
```

### 3.4 会员数据模型

```typescript
// src/modules/membership/entities/membership.entity.ts
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, JoinColumn } from 'typeorm';
import { User } from '../../users/entities/user.entity';

@Entity('memberships')
export class Membership {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string;

  @Column({
    type: 'enum',
    enum: ['free', 'monthly', 'yearly', 'lifetime'],
    default: 'free'
  })
  level: string;

  @Column({ type: 'timestamp', nullable: true })
  startDate: Date;

  @Column({ type: 'timestamp', nullable: true })
  expiryDate: Date;

  @Column({ type: 'boolean', default: false })
  isActive: boolean;

  @Column({ type: 'int', default: 0 })
  totalAIQuota: number;  // 总 AI 配额

  @Column({ type: 'int', default: 0 })
  usedAIQuota: number;  // 已使用 AI 配额

  @Column({ type: 'boolean', default: true })
  canSync: boolean;  // 是否可以同步

  @Column({ type: 'boolean', default: false })
  canExport: boolean;  // 是否可以导出

  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;

  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })
  updatedAt: Date;

  // 计算属性 - 剩余 AI 配额
  get remainingAIQuota(): number {
    return this.totalAIQuota - this.usedAIQuota;
  }

  // 计算属性 - 会员是否有效
  get isValid(): boolean {
    if (!this.isActive) return false;
    if (this.level === 'free') return false;
    if (this.expiryDate && new Date() > this.expiryDate) return false;
    return true;
  }

  // 关联用户
  @ManyToOne(() => User, (user) => user.membership)
  @JoinColumn({ name: 'userId' })
  user: User;
}
```

### 3.5 权限验证服务

```typescript
// src/modules/permissions/permissions.service.ts
import { Injectable, ForbiddenException } from '@nestjs/common';
import { UserService } from '../users/user.service';
import { MembershipService } from '../memberships/membership.service';

@Injectable()
export class PermissionsService {
  constructor(
    private userService: UserService,
    private membershipService: MembershipService,
  ) {}

  /**
   * 检查用户是否有某项权限
   */
  async checkPermission(userId: string, permission: Permission): Promise<boolean> {
    const user = await this.userService.findById(userId);
    const membership = await this.membershipService.findByUserId(userId);

    // 游客无权限
    if (!user) {
      return permission.isFree;
    }

    // 免费用户
    if (!membership || !membership.isValid) {
      return permission.isFree;
    }

    // 付费用户
    return this.hasPermissionByLevel(membership.level, permission);
  }

  /**
   * 检查文章数量限制
   */
  async checkArticleLimit(userId: string): Promise<boolean> {
    const user = await this.userService.findById(userId);
    const membership = await this.membershipService.findByUserId(userId);

    if (!membership || membership.level === 'free') {
      // 免费用户限制 100 篇
      return user.articleCount < 100;
    }

    // 付费用户无限制
    return true;
  }

  /**
   * 检查 AI 配额
   */
  async checkAIQuota(userId: string): Promise<boolean> {
    const membership = await this.membershipService.findByUserId(userId);
    return membership && membership.remainingAIQuota > 0;
  }

  /**
   * 扣减 AI 配额
   */
  async decrementAIQuota(userId: string): Promise<void> {
    await this.membershipService.incrementUsedAIQuota(userId);
  }

  /**
   * 根据会员等级判断权限
   */
  private hasPermissionByLevel(level: string, permission: Permission): boolean {
    if (level === 'free') {
      return permission.isFree;
    }

    // 月度、年度、终身会员拥有全部权限
    return true;
  }
}

/**
 * 权限枚举
 */
export enum Permission {
  // 免费权限
  VIEW_ARTICLE = 'view_article',
  CREATE_ARTICLE = 'create_article',
  EDIT_PROFILE = 'edit_profile',

  // 会员权限
  CLOUD_STORAGE = 'cloud_storage',
  AI_WRITING_ASSISTANT = 'ai_writing_assistant',
  ADVANCED_STATISTICS = 'advanced_statistics',
  CUSTOM_THEME = 'custom_theme',
  UNLIMITED_ARTICLES = 'unlimited_articles',
  PRIORITY_SUPPORT = 'priority_support',
  EXPORT_ARTICLES = 'export_articles',
  DATA_SYNC = 'data_sync',
}

/**
 * 权限扩展
 */
Permission.prototype.isFree = function(this: Permission): boolean {
  return [
    Permission.VIEW_ARTICLE,
    Permission.CREATE_ARTICLE,
    Permission.EDIT_PROFILE,
  ].includes(this);
};
```

### 3.6 API 响应拦截器 (自动添加权限信息)

```typescript
// src/common/interceptors/permission.interceptor.ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/core';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable()
export class PermissionInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    return next.handle().pipe(
      map(data => {
        // 如果有用户信息,自动附加权限信息
        if (user) {
          return {
            ...data,
            permissions: {
              isAuthenticated: user.isAuthenticated || false,
              isPaidMember: user.isPaidMember || false,
              membershipLevel: user.membershipLevel || 'free',
              canSync: user.canSync || false,
              canUseAI: user.remainingAIQuota > 0,
              remainingArticles: user.remainingArticles || 0,
            },
          };
        }

        // 游客
        return {
          ...data,
          permissions: {
            isAuthenticated: false,
            isPaidMember: false,
            membershipLevel: 'guest',
            canSync: false,
            canUseAI: false,
            remainingArticles: 50,  // 游客限制 50 篇
          },
        };
      }),
    );
  }
}
```

---

## 4. 客户端设计

### 4.1 权限检查工具类

```dart
// lib/core/permission/permission_checker.dart
import 'package:flutter/material.dart';
import '../providers/auth_provider.dart';
import '../providers/membership_provider.dart';
import '../data/models/membership.dart';
import '../widgets/app_toast.dart';

/// 权限检查工具类
class PermissionChecker {
  /// 检查权限并执行操作
  /// 如果没有权限,显示提示并返回 false
  static Future<bool> checkPermission(
    BuildContext context,
    Permission permission, {
    String? customMessage,
  }) async {
    final authProvider = context.read<AuthProvider>();
    final membershipProvider = context.read<MembershipProvider>();

    // 1. 检查是否登录
    if (!authProvider.isAuthenticated) {
      _showAuthDialog(context, permission);
      return false;
    }

    // 2. 检查会员状态
    final membership = membershipProvider.membership;
    if (membership == null || !membership.isValid) {
      _showMembershipDialog(context, permission);
      return false;
    }

    // 3. 检查具体权限
    if (!membershipProvider.checkPermission(permission)) {
      _showUpgradeDialog(context, permission);
      return false;
    }

    return true;
  }

  /// 显示登录对话框
  static void _showAuthDialog(BuildContext context, Permission permission) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('需要登录'),
        content: Text('使用${permission.displayName}功能需要先登录'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('稍后再说'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // 跳转到登录页
              Navigator.pushNamed(context, '/login');
            },
            child: const Text('去登录'),
          ),
        ],
      ),
    );
  }

  /// 显示会员过期对话框
  static void _showMembershipDialog(BuildContext context, Permission permission) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('会员已过期'),
        content: Text('您的会员已过期,${permission.displayName}功能需要有效会员'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('我知道了'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // 跳转到会员页
              Navigator.pushNamed(context, '/membership');
            },
            child: const Text('去续费'),
          ),
        ],
      ),
    );
  }

  /// 显示升级会员对话框
  static void _showUpgradeDialog(BuildContext context, Permission permission) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('升级会员'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('${permission.displayName}功能需要升级会员'),
            const SizedBox(height: 16),
            Text('会员权益:'),
            const SizedBox(height: 8),
            _buildBenefitList(),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('暂不需要'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              // 跳转到会员页
              Navigator.pushNamed(context, '/membership');
            },
            child: const Text('查看会员权益'),
          ),
        ],
      ),
    );
  }

  static Widget _buildBenefitList() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildBenefitItem('✅ 云端存储,多设备同步'),
        _buildBenefitItem('✅ AI 写作助手'),
        _buildBenefitItem('✅ 无限文章数量'),
        _buildBenefitItem('✅ 导出 PDF/Markdown'),
        _buildBenefitItem('✅ 自定义主题'),
      ],
    );
  }

  static Widget _buildBenefitItem(String text) {
    return Padding(
      padding: const EdgeInsets.only(left: 16, bottom: 4),
      child: Text(text, style: const TextStyle(fontSize: 14)),
    );
  }
}
```

### 4.2 Provider 更新逻辑

#### 4.2.1 ActivityProvider 权限控制

```dart
// lib/providers/activity_provider.dart
class ActivityProvider extends ChangeNotifier {
  // ... 现有代码

  /// 更新文章的标题和内容 (带权限检查)
  Future<void> updateArticleContent(
    String articleId, {
    String? title,
    dynamic content,
  }) async {
    // 查找文章
    final article = _articles.firstWhere((a) => a.id == articleId);

    // 检查是否真的有变化
    final titleChanged = title != null && title != article.title;
    final contentChanged = content != null && content != article.content;

    if (!titleChanged && !contentChanged) {
      return;
    }

    // 1. 立即更新本地存储 (所有用户都可以)
    final updatedArticle = article.copyWith(
      title: title,
      content: content,
      updatedAt: DateTime.now(),
    );
    final success = await _articleStorage.updateArticle(updatedArticle);

    if (!success) {
      appLogger.error('本地存储更新失败: updateArticle (content)', articleId);
      return;
    }

    // 2. 更新内存中的文章状态
    final updatedArticles = _articles.map((a) {
      if (a.id == articleId) {
        return updatedArticle;
      }
      return a;
    }).toList();

    _articles = updatedArticles;
    _activities = MockDataService.generateActivityDataFromArticles(_articles);
    notifyListeners();

    // 3. 检查是否有云端同步权限 (仅会员同步)
    final authProvider = _container.read<AuthProvider>();
    final membershipProvider = _container.read<MembershipProvider>();

    if (!authProvider.isAuthenticated) {
      appLogger.info('游客模式,仅本地存储,不同步到云端');
      return;
    }

    if (!membershipProvider.isValidMember) {
      appLogger.info('免费用户,仅本地存储,不同步到云端');
      return;
    }

    // 4. 异步调用 API (仅会员)
    _articleRepository.updateArticle(updatedArticle).then((result) {
      if (result.isSuccess) {
        appLogger.info('✅ API 同步成功: 文章内容已更新 | articleId: $articleId');
      } else {
        appLogger.error('❌ API 同步失败: 文章内容同步到服务器失败 | articleId: $articleId');
      }
    }).catchError((error) {
      appLogger.error('❌ API 同步异常: 文章内容同步出错 | articleId: $articleId', error);
    });
  }

  /// 创建新文章 (带权限检查)
  Future<Article?> createNewArticle() async {
    // 检查文章数量限制
    final authProvider = _container.read<AuthProvider>();
    final membershipProvider = _container.read<MembershipProvider>();

    if (!authProvider.isAuthenticated) {
      // 游客限制 50 篇
      if (_articles.length >= 50) {
        AppToast.showError('游客最多创建 50 篇文章,登录后可创建更多');
        return null;
      }
    } else if (!membershipProvider.isValidMember) {
      // 免费用户限制 100 篇
      if (_articles.length >= 100) {
        AppToast.showError('免费用户最多创建 100 篇文章,升级会员可无限制');
        return null;
      }
    }

    // 创建一个空文章
    final now = DateTime.now();
    final newArticle = Article(
      id: now.millisecondsSinceEpoch.toString(),
      title: '',
      date: now,
      updatedAt: now,
      content: null,
    );

    // 1. 立即更新本地存储
    final success = await _articleStorage.createArticle(newArticle);

    if (!success) {
      appLogger.error('本地存储创建失败: createArticle', newArticle.id);
      return null;
    }

    // 2. 添加到内存中的文章列表
    _articles.insert(0, newArticle);
    _activities = MockDataService.generateActivityDataFromArticles(_articles);
    notifyListeners();

    // 3. 检查是否有云端同步权限
    if (!authProvider.isAuthenticated || !membershipProvider.isValidMember) {
      appLogger.info('游客/免费用户,仅本地存储,不同步到云端');
      return newArticle;
    }

    // 4. 异步调用 API (仅会员)
    _articleRepository.createArticle(newArticle).then((result) {
      if (result.isSuccess) {
        appLogger.info('✅ API 同步成功: 新文章已创建 | articleId: ${newArticle.id}');
      } else {
        appLogger.error('❌ API 同步失败: 新文章同步到服务器失败 | articleId: ${newArticle.id}');
      }
    }).catchError((error) {
      appLogger.error('❌ API 同步异常: 新文章同步出错 | articleId: ${newArticle.id}', error);
    });

    return newArticle;
  }
}
```

#### 4.2.2 AI 面板权限控制

```dart
// lib/pages/article_detail/article_ai_panel.dart
class _AIPanelState extends State<AIPanel> {
  // ... 现有代码

  /// 生成 AI 建议 (带权限检查)
  Future<void> _generateAISuggestion({bool forceRefresh = false}) async {
    if (_originalText.isEmpty) return;

    // 权限检查
    final hasPermission = await PermissionChecker.checkPermission(
      context,
      Permission.aiWritingAssistant,
    );

    if (!hasPermission) {
      setState(() {
        _hasError = true;
        _aiSuggestion = '';
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _aiSuggestion = '';
    });

    try {
      // 检查 AI 配额
      final membershipProvider = context.read<MembershipProvider>();
      if (membershipProvider.remainingAIQuota <= 0) {
        AppToast.showError('AI 配额已用完,请升级会员');
        setState(() {
          _hasError = true;
          _isLoading = false;
        });
        return;
      }

      // 调用 AI API
      final suggestion = await _callAIAPI(_originalText);

      // 扣减配额
      // TODO: 通过 API 扣减配额

      // 流式显示
      await _streamText(suggestion);

      // 更新缓存
      _cacheManager.updateSuggestion(_originalText, suggestion);
    } catch (e) {
      appLogger.error('AI 生成失败: $e');
      AppToast.showError('AI 生成失败,请稍后重试');
      setState(() {
        _hasError = true;
        _isLoading = false;
      });
    }
  }

  Future<String> _callAIAPI(String text) async {
    // TODO: 调用真实的 AI API
    // 当前是模拟实现
    await Future.delayed(const Duration(milliseconds: 500));
    return '$text (这是 AI 的扩写建议)';
  }
}
```

### 4.3 UI 层权限控制示例

```dart
// lib/pages/home_page.dart
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer2<AuthProvider, MembershipProvider>(
      builder: (context, authProvider, membershipProvider, child) {
        return Scaffold(
          appBar: AppBar(
            title: const Text('言意合一'),
            actions: [
              // 同步按钮 (仅会员可见)
              if (membershipProvider.isValidMember)
                IconButton(
                  icon: const Icon(Icons.cloud_sync),
                  onPressed: () => _handleSync(context),
                ),
              // 会员按钮
              IconButton(
                icon: const Icon(Icons.card_membership),
                onPressed: () => Navigator.pushNamed(context, '/membership'),
              ),
            ],
          ),
          body: Column(
            children: [
              // 会员状态横幅
              if (!membershipProvider.isValidMember)
                _buildMembershipBanner(context),

              // 文章列表
              Expanded(child: ArticleList()),
            ],
          ),
        );
      },
    );
  }

  Widget _buildMembershipBanner(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      color: Colors.amber.shade50,
      child: Row(
        children: [
          const Icon(Icons.cloud_off, color: Colors.orange),
          const SizedBox(width: 12),
          const Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('升级会员,解锁云端存储', style: TextStyle(fontWeight: FontWeight.bold)),
                Text('数据自动同步,多设备访问', style: TextStyle(fontSize: 12)),
              ],
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pushNamed(context, '/membership'),
            child: const Text('查看权益'),
          ),
        ],
      ),
    );
  }

  void _handleSync(BuildContext context) async {
    final hasPermission = await PermissionChecker.checkPermission(
      context,
      Permission.dataSync,
    );

    if (hasPermission) {
      AppToast.showSuccess('正在同步...');
      // 执行同步逻辑
    }
  }
}
```

### 4.4 初始化流程调整

```dart
// lib/main.dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // 初始化日志系统
  appLogger.init();
  appLogger.info('应用启动中...');

  // 初始化核心服务
  final prefs = await SharedPreferences.getInstance();
  final storage = await LocalStorageService.getInstance();

  // 初始化文章存储服务
  final articleStorage = ArticleStorageService.getInstance(storage);
  await articleStorage.initializeArticles();

  // 创建 API 服务
  final apiService = ApiServiceFactory.getInstance();

  runApp(
    MultiProvider(
      providers: [
        // 核心服务
        Provider<LocalStorageService>.value(value: storage),
        Provider<ApiService>.value(value: apiService),

        // 认证和会员
        ChangeNotifierProxyProvider2<
          LocalStorageService,
          ApiService,
          AuthProvider
        >(
          create: (_) => AuthProvider(storage: storage, apiService: apiService),
          update: (_, storage, apiService, auth) =>
              auth ?? AuthProvider(storage: storage, apiService: apiService),
        ),

        ChangeNotifierProxyProvider2<
          LocalStorageService,
          ApiService,
          MembershipProvider
        >(
          create: (_) =>
              MembershipProvider(storage: storage, apiService: apiService),
          update: (_, storage, apiService, membership) =>
              membership ??
              MembershipProvider(storage: storage, apiService: apiService),
        ),

        // 活动数据 Provider (依赖认证和会员)
        ChangeNotifierProxyProvider3(
          ApiService,
          ArticleStorageService,
          AuthProvider,
          ActivityProvider,
          update: (_, apiService, articleStorage, authProvider, activityProvider) {
            // 如果是首次创建或需要更新
            return activityProvider ?? ActivityProvider(
              apiService: apiService,
              articleStorage: articleStorage,
              delayInit: true,
            );
          },
          create: (_) => null,  // 延迟创建
        ),

        // 现有 Providers
        ChangeNotifierProvider(create: (_) => ThemeProvider(prefs: prefs)),
        ChangeNotifierProvider(create: (_) => UserProvider(prefs: prefs)),
      ],
      child: const MyApp(),
    ),
  );
}
```

### 4.5 游客升级引导

```dart
// lib/pages/guest_upgrade_page.dart
class GuestUpgradePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('升级会员'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 游客当前状态
            _buildCurrentStatusCard(),

            const SizedBox(height: 24),

            // 会员权益对比
            _buildComparisonCard(),

            const SizedBox(height: 24),

            // 升级按钮
            _buildUpgradeButtons(context),
          ],
        ),
      ),
    );
  }

  Widget _buildCurrentStatusCard() {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        return Card(
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('当前状态', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                _buildStatusRow('模式', '游客模式'),
                _buildStatusRow('文章数量', '最多 50 篇'),
                _buildStatusRow('数据存储', '仅本地存储'),
                _buildStatusRow('数据同步', '❌ 不支持'),
                _buildStatusRow('AI 助手', '❌ 不支持'),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildStatusRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.grey)),
          Text(value, style: const TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }

  Widget _buildComparisonCard() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text('会员权益', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            const SizedBox(height: 16),
            _buildFeatureRow('无限文章数量', Icons.check_circle, Colors.green),
            _buildFeatureRow('云端数据存储', Icons.check_circle, Colors.green),
            _buildFeatureRow('多设备数据同步', Icons.check_circle, Colors.green),
            _buildFeatureRow('AI 写作助手', Icons.check_circle, Colors.green),
            _buildFeatureRow('数据统计分析', Icons.check_circle, Colors.green),
            _buildFeatureRow('导出 PDF/Markdown', Icons.check_circle, Colors.green),
            _buildFeatureRow('自定义主题', Icons.check_circle, Colors.green),
            const Divider(height: 32),
            _buildFeatureRow('优先客服支持', Icons.check_circle, Colors.green),
          ],
        ),
      ),
    );
  }

  Widget _buildFeatureRow(String text, IconData icon, Color color) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        children: [
          Icon(icon, color: color, size: 20),
          const SizedBox(width: 12),
          Text(text),
        ],
      ),
    );
  }

  Widget _buildUpgradeButtons(BuildContext context) {
    return Column(
      children: [
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: () => _handleLogin(context),
            style: ElevatedButton.styleFrom(
              padding: const EdgeInsets.symmetric(vertical: 16),
              backgroundColor: Colors.green,
            ),
            child: const Text('登录账号', style: TextStyle(fontSize: 16)),
          ),
        ),
        const SizedBox(height: 12),
        const Text('已有账号?登录后可继续使用免费功能'),
        const SizedBox(height: 24),
        const Text(
          '升级会员即可解锁全部功能',
          style: TextStyle(fontSize: 12, color: Colors.grey),
        ),
      ],
    );
  }

  void _handleLogin(BuildContext context) {
    Navigator.pushNamed(context, '/login');
  }
}
```

---

## 5. 数据迁移方案

### 5.1 游客数据迁移到云端

```dart
// lib/services/data_migration_service.dart
class DataMigrationService {
  final ArticleStorageService _articleStorage;
  final ArticleRepository _articleRepository;

  DataMigrationService({
    required ArticleStorageService articleStorage,
    required ArticleRepository articleRepository,
  })  : _articleStorage = articleStorage,
        _articleRepository = articleRepository;

  /// 迁移本地数据到云端
  Future<MigrationResult> migrateToCloud(String userId) async {
    try {
      // 1. 加载本地所有文章
      final localArticles = await _articleStorage.loadArticles();

      if (localArticles.isEmpty) {
        return MigrationResult(success: true, migratedCount: 0);
      }

      int migratedCount = 0;
      int failedCount = 0;
      final List<String> errors = [];

      // 2. 逐个上传到云端
      for (final article in localArticles) {
        try {
          final result = await _articleRepository.createArticle(article);

          if (result.isSuccess) {
            migratedCount++;
            appLogger.info('迁移成功: ${article.id}');
          } else {
            failedCount++;
            errors.add('文章 ${article.id} 迁移失败: ${result.getError?.message}');
            appLogger.error('迁移失败: ${article.id}', result.getError);
          }
        } catch (e) {
          failedCount++;
          errors.add('文章 ${article.id} 迁移异常: $e');
          appLogger.error('迁移异常: ${article.id}', e);
        }
      }

      // 3. 返回迁移结果
      return MigrationResult(
        success: failedCount == 0,
        totalCount: localArticles.length,
        migratedCount: migratedCount,
        failedCount: failedCount,
        errors: errors,
      );
    } catch (e) {
      appLogger.error('迁移服务异常', e);
      return MigrationResult(
        success: false,
        errors: ['迁移服务异常: $e'],
      );
    }
  }

  /// 显示迁移进度对话框
  Future<void> showMigrationDialog(BuildContext context, String userId) async {
    return showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => _MigrationDialog(
        userId: userId,
        migrationService: this,
      ),
    );
  }
}

/// 迁移结果
class MigrationResult {
  final bool success;
  final int totalCount;
  final int migratedCount;
  final int failedCount;
  final List<String> errors;

  MigrationResult({
    required this.success,
    this.totalCount = 0,
    this.migratedCount = 0,
    this.failedCount = 0,
    this.errors = const [],
  });
}

/// 迁移进度对话框
class _MigrationDialog extends StatefulWidget {
  final String userId;
  final DataMigrationService migrationService;

  const _MigrationDialog({
    required this.userId,
    required this.migrationService,
  });

  @override
  State<_MigrationDialog> createState() => _MigrationDialogState();
}

class _MigrationDialogState extends State<_MigrationDialog> {
  bool _isLoading = true;
  MigrationResult? _result;

  @override
  void initState() {
    super.initState();
    _startMigration();
  }

  Future<void> _startMigration() async {
    final result = await widget.migrationService.migrateToCloud(widget.userId);

    setState(() {
      _isLoading = false;
      _result = result;
    });
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('数据迁移中...'),
      content: _isLoading
          ? const Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                CircularProgressIndicator(),
                SizedBox(height: 16),
                Text('正在将本地数据迁移到云端...'),
              ],
            )
          : Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (_result!.success) ...[
                  const Icon(Icons.check_circle, color: Colors.green, size: 48),
                  const SizedBox(height: 16),
                  Text('成功迁移 ${_result!.migratedCount} 篇文章'),
                ] else ...[
                  const Icon(Icons.error, color: Colors.red, size: 48),
                  const SizedBox(height: 16),
                  Text('迁移完成,部分失败'),
                  const SizedBox(height: 8),
                  Text('成功: ${_result!.migratedCount}, 失败: ${_result!.failedCount}'),
                  if (_result!.errors.isNotEmpty) ...[
                    const SizedBox(height: 16),
                    const Text('错误信息:', style: TextStyle(fontWeight: FontWeight.bold)),
                    ..._result!.errors.take(3).map((e) => Text('• $e', style: const TextStyle(fontSize: 12))),
                    if (_result!.errors.length > 3)
                      Text('...还有 ${_result!.errors.length - 3} 条错误', style: const TextStyle(fontSize: 12)),
                  ],
                ],
              ],
            ),
      actions: [
        if (!_isLoading)
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('确定'),
          ),
      ],
    );
  }
}
```

### 5.2 会员页集成迁移功能

```dart
// lib/pages/membership_page.dart
class MembershipPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        // 如果是游客,显示迁移引导
        if (authProvider.isGuest) {
          return _buildGuestView(context);
        }

        // 如果是免费用户,显示升级选项
        return _buildFreeUserView(context);
      },
    );
  }

  Widget _buildGuestView(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('会员中心')),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // 游客提示卡片
          Card(
            color: Colors.blue.shade50,
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Icon(Icons.info_outline, color: Colors.blue.shade700),
                      const SizedBox(width: 8),
                      const Text('游客模式', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                    ],
                  ),
                  const SizedBox(height: 12),
                  const Text('您当前正在使用游客模式,数据仅保存在本地设备。'),
                  const SizedBox(height: 8),
                  const Text('登录或升级会员后,可将数据迁移到云端,实现多设备同步。'),
                  const SizedBox(height: 16),
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () => Navigator.pushNamed(context, '/login'),
                          child: const Text('登录账号'),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: OutlinedButton(
                          onPressed: () => _showMembershipPlans(context),
                          child: const Text('查看会员'),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),

          const SizedBox(height: 24),

          // 功能对比
          _buildFeatureComparison(),
        ],
      ),
    );
  }

  Widget _buildFreeUserView(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('会员中心')),
      body: Consumer<MembershipProvider>(
        builder: (context, membershipProvider, child) {
          final membership = membershipProvider.membership;

          return ListView(
            padding: const EdgeInsets.all(16),
            children: [
              // 当前会员状态
              Card(
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(
                            membership?.isValid == true ? Icons.verified : Icons.info_outline,
                            color: membership?.isValid == true ? Colors.green : Colors.orange,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            membership?.level.displayName ?? '免费用户',
                            style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                          ),
                        ],
                      ),
                      if (membership != null) ...[
                        const SizedBox(height: 16),
                        _buildMembershipInfo(membership),
                      ],
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 24),

              // 数据迁移选项 (免费用户可见)
              if (membership?.level == MembershipLevel.free)
                Card(
                  child: ListTile(
                    leading: const Icon(Icons.cloud_upload),
                    title: const Text('迁移数据到云端'),
                    subtitle: const Text('将本地数据迁移到云端,实现多设备同步'),
                    trailing: const Icon(Icons.chevron_right),
                    onTap: () => _handleDataMigration(context),
                  ),
                ),

              const SizedBox(height: 24),

              // 会员套餐
              _buildMembershipPlans(),

              const SizedBox(height: 24),

              // 权益列表
              _buildBenefitsList(),
            ],
          );
        },
      ),
    );
  }

  Widget _buildMembershipInfo(Membership membership) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        if (membership.isValid) ...[
          _buildInfoRow('会员等级', membership.level.displayName),
          _buildInfoRow('开始日期', _formatDate(membership.startDate)),
          _buildInfoRow('到期日期', _formatDate(membership.expiryDate)),
          _buildInfoRow('剩余天数', '${membership.remainingDays} 天'),
          if (membership.isPaidMember) ...[
            _buildInfoRow('AI 配额', '${membership.remainingAIQuota} 次'),
            _buildInfoRow('数据同步', '✅ 支持'),
            _buildInfoRow('数据导出', '✅ 支持'),
          ],
        ] else ...[
          _buildInfoRow('会员状态', '已过期'),
          const SizedBox(height: 12),
          ElevatedButton(
            onPressed: () => _showMembershipPlans(context),
            child: const Text('立即续费'),
          ),
        ],
      ],
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: Colors.grey)),
          Text(value, style: const TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }

  void _handleDataMigration(BuildContext context) async {
    final authProvider = context.read<AuthProvider>();
    final userId = authProvider.userId;

    if (userId == null) {
      AppToast.showError('请先登录');
      return;
    }

    final migrationService = DataMigrationService(
      articleStorage: context.read<ArticleStorageService>(),
      articleRepository: ArticleRepository(apiService: context.read<ApiService>()),
    );

    await migrationService.showMigrationDialog(context, userId);
  }

  String _formatDate(DateTime? date) {
    if (date == null) return '-';
    return '${date.year}-${date.month.toString().padLeft(2, '0')}-${date.day.toString().padLeft(2, '0')}';
  }
}
```

---

## 6. 实施步骤

### Phase 1: 基础设施搭建 (Week 1)

#### 服务端
1. ✅ 创建权限守卫 (`AuthGuard`)
2. ✅ 创建用户类型装饰器 (`@UserType`)
3. ✅ 扩展用户数据模型 (添加 `membershipLevel`, `isPaidMember` 字段)
4. ✅ 创建会员数据模型 (`Membership` entity)
5. ✅ 实现权限验证服务 (`PermissionsService`)

#### 客户端
1. ✅ 创建权限检查工具类 (`PermissionChecker`)
2. ✅ 创建权限枚举类 (`Permission`)
3. ✅ 实现权限对话框组件

### Phase 2: API 权限控制 (Week 2)

#### 服务端
1. ✅ 应用权限守卫到所有 Controller
2. ✅ 实现会员状态查询 API
3. ✅ 实现文章数量限制检查
4. ✅ 实现 AI 配额管理
5. ✅ 添加权限信息到 API 响应

#### 客户端
1. ✅ 更新 `ActivityProvider` 添加权限检查
2. ✅ 更新 `ArticleEditorController` 添加权限检查
3. ✅ 更新 AI 面板添加权限检查

### Phase 3: UI 权限控制 (Week 3)

1. ✅ 实现会员状态横幅
2. ✅ 实现权限引导对话框
3. ✅ 更新首页显示会员状态
4. ✅ 实现数据迁移功能
5. ✅ 实现会员中心页面

### Phase 4: 测试与优化 (Week 4)

1. ✅ 单元测试 (权限检查逻辑)
2. ✅ 集成测试 (API 权限验证)
3. ✅ UI 测试 (权限引导流程)
4. ✅ 性能优化 (缓存权限信息)
5. ✅ 文档完善 (使用说明)

---

## 7. 总结

### 7.1 架构优势

1. **渐进式体验**: 游客 → 免费用户 → 会员,平滑过渡
2. **本地优先**: 所有用户都可以立即使用本地功能
3. **明确权限**: 每个功能都有清晰的权限要求
4. **友好提示**: 权限不足时提供明确的升级引导
5. **数据安全**: 不同权限等级的数据物理隔离

### 7.2 关键点

1. **权限守卫**: 服务端统一拦截未授权请求
2. **权限检查**: 客户端操作前预检查权限
3. **用户引导**: 权限不足时友好提示并引导升级
4. **数据迁移**: 游客升级后可平滑迁移数据到云端
5. **配额管理**: AI 配额、文章数量限制等

### 7.3 后续优化

1. **实时同步**: WebSocket 推送会员状态变更
2. **配额提醒**: AI 配额不足时提前提醒
3. **试用机制**: 新用户免费试用会员功能
4. **邀请奖励**: 邀请好友获得会员权益
5. **活动优惠**: 节假日会员促销活动

---

**文档版本**: v1.0
**最后更新**: 2025-01-05
**作者**: Claude (Sonnet 4.5)
